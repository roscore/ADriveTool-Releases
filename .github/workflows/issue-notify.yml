name: Issue → HIMARI

on:
  issues:
    types: [opened, reopened]

jobs:
  notify:
    runs-on: [self-hosted, himari]
    timeout-minutes: 1
    steps:
      - name: Notify OpenClaw
        env:
          HOOK_TOKEN: ${{ secrets.OPENCLAW_HOOK_TOKEN }}
        run: |
          TITLE="${{ github.event.issue.title }}"
          NUMBER="${{ github.event.issue.number }}"
          AUTHOR="${{ github.event.issue.user.login }}"
          URL="${{ github.event.issue.html_url }}"
          BODY=$(echo '${{ toJSON(github.event.issue.body) }}' | head -c 1000)

          MESSAGE="[ADriveTool-Releases 이슈 #${NUMBER}] ${TITLE}
          작성자: ${AUTHOR}
          URL: ${URL}
          내용: ${BODY}

          처리 절차:
          1. 이슈 내용을 분석하고 심각도/유형을 판단해
          2. 선생님(텔레그램 5640466668)에게 분석 결과와 대응 방안을 보고해
          3. 대응을 실행해 (이슈 답변, 필요시 roscore/ADriveTool private 레포에서 코드 수정 + WSL 테스트)
          4. 대응 완료 후 처리 결과를 선생님에게 보고해 (이슈를 열어둘지/닫을지 판단 포함)
          참고: 코드 수정이 필요하면 반드시 WSL에서 동작 테스트 후 커밋할 것."

          curl -sf -X POST http://127.0.0.1:18789/hooks/agent \
            -H "Authorization: Bearer ${HOOK_TOKEN}" \
            -H "Content-Type: application/json" \
            -d "$(jq -n \
              --arg msg "$MESSAGE" \
              --arg key "hook:adrivetool-issue-${NUMBER}" \
              '{message: $msg, name: "ADriveTool", sessionKey: $key, deliver: true, channel: "telegram", to: "5640466668"}')"
